{% extends "base.html" %}

{% block content %}
<link href="https://unpkg.com/botui/build/botui.min.css" rel="stylesheet" crossorigin="anonymous">
<link href="https://unpkg.com/botui/build/botui-theme-default.css" rel="stylesheet" crossorigin="anonymous">
<script type="text/javascript" src="https://cdn.jsdelivr.net/vue/latest/vue.min.js" crossorigin></script>
<script type="text/javascript" src="https://unpkg.com/botui/build/botui.min.js" crossorigin></script>
<div id="app">
  <h5>ğŸ¤–ğŸ¤–ğŸ¤–ğŸ¤–ğŸ¤–ğŸ¤–ğŸ¤–ğŸ¤–ğŸ¤–ğŸ¤–ğŸ¤–ğŸ¤–ğŸ¤–ğŸ¤–ğŸ¤–ğŸ¤–ğŸ¤–ğŸ¤–ğŸ¤–ğŸ¤–ğŸ¤–ğŸ¤–ğŸ¤–ğŸ¤–</h5>
  <div id="crm-bot">
    <bot-ui></bot-ui>
  </div>
  <div class="input-group mb-3">
  <input v-model="user_input" type="text" class="form-control" placeholder="è¯·è¾“å…¥..." aria-label="Recipient's username" aria-describedby="basic-addon2">
    <div class="input-group-append">
      <button class="btn btn-outline-secondary" type="button" @click="onUserInput()">æäº¤</button>
    </div>
  </div>
</div>

<script>
  new Vue({
    el: '#app',
    data: {
      user_input: "",
      uibot: null,
    },
    created: function() {
      this.initWebSocket();
    },
    destroyed() {
      this.ws.close()
    },
    mounted:function(){
        this.botui = new BotUI('crm-bot');
        this.botui.message.add({
          content: 'ä½ å¥½!'
        });
    },
    methods: {
      initWebSocket(){ //åˆå§‹åŒ–weosocket
        const wsuri = "ws://127.0.0.1:8000";
        this.ws = new WebSocket(wsuri);
        this.ws.onmessage = this.websocketonmessage;
        this.ws.onopen = this.websocketonopen;
        this.ws.onerror = this.websocketonerror;
        this.ws.onclose = this.websocketclose;
      },
      websocketonopen(){ //è¿æ¥å»ºç«‹ä¹‹åæ‰§è¡Œsendæ–¹æ³•å‘é€æ•°æ®
        console.log("on open...")
      },
      websocketonerror(){//è¿æ¥å»ºç«‹å¤±è´¥é‡è¿
        this.initWebSocket();
      },
      websocketonmessage(e){ //æ•°æ®æ¥æ”¶
        this.botui.message.add({
          content: e.data,
        });
      },
      websocketclose(e){  //å…³é—­
        console.log('æ–­å¼€è¿æ¥',e);
      },
      onUserInput: function() {
        var that = this;
        this.botui.message.add({
          content: that.user_input,
          human: true
        });
        this.ws.send(that.user_input);
        that.user_input = "";
      }
    }
  })
</script>
{% endblock content %}
